name: CI e PublicaÃ§Ã£o de Resultados

on:
  push:
    # Ajustei para os branches que vocÃª tem no seu repositÃ³rio. 
    # Mantenha 'ci' apenas se for o branch principal de trabalho.
    branches: [ "main", "exercicios/modulo-4" ]
  workflow_dispatch:

jobs:
  test_and_publish: # Nome do job alterado para maior clareza
    runs-on: ubuntu-latest
    
    # PermissÃµes necessÃ¡rias para que o deploy no Pages funcione corretamente
    permissions:
      contents: write # NecessÃ¡rio para o peaceiris/actions-gh-pages
      pages: write
      id-token: write

    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4

    - name: âš™ï¸ Configurar Node.js
      uses: actions/setup-node@v4 # Atualizei para a versÃ£o mais recente
      with:
        node-version: '20' 
        
    - name: ğŸ“¦ Instalar DependÃªncias
      # Instala todos os pacotes (incluindo start-server-and-test e serverest)
      run: npm install

    # ğŸ¯ PARTE CRÃTICA: RODA O SCRIPT QUE INICIA O SERVIDOR E TESTA
    # Este Ã© o comando mais robusto para vocÃª, pois usa o 'cy:run-ci' que vocÃª jÃ¡ definiu.
    - name: ğŸ§ª Rodar Testes (Serverest + Cypress)
      run: npm run cy:run-ci
      # O continue-on-error nÃ£o Ã© necessÃ¡rio aqui, pois o "cy:run-ci" deve passar para prosseguir.

    # 4. PublicaÃ§Ã£o do RelatÃ³rio (Usando peaceiris/actions-gh-pages)
    - name: â¬†ï¸ Publicar RelatÃ³rio de Testes (Mochawesome)
      uses: peaceiris/actions-gh-pages@v3
      with:
        # Token de seguranÃ§a para permissÃ£o de escrita no GH Pages
        github_token: ${{ secrets.GITHUB_TOKEN }}
        # DiretÃ³rio onde o relatÃ³rio foi gerado.
        # Ajuste este caminho se o seu relatÃ³rio final estiver em outro lugar!
        publish_dir: ./mochawesome-report
        # O branch de deploy padrÃ£o que a Action irÃ¡ criar/atualizar
        publish_branch: gh-pages