name: CI e PublicaÃ§Ã£o de Resultados

on:
  push:
    # A Action serÃ¡ disparada quando houver push nos branches 'main' E 'exercicios/modulo-4'
    branches: [ "main", "exercicios/modulo-4" ]
  workflow_dispatch:

jobs:
  test_and_publish:
    runs-on: ubuntu-latest
    
    # Define as permissÃµes necessÃ¡rias para o deploy no Pages
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4

    - name: âš™ï¸ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # VersÃ£o recomendada para o Cypress/Node.js
        
    - name: ğŸ“¦ Instalar DependÃªncias
      run: npm install

    # ğŸ¯ ESTAPA CRÃTICA: INICIA O SERVIDOR E RODA TESTES
    - name: ğŸ§ª Rodar Testes e Esperar Servidor
      # Usamos 'cy:run-ci' que no seu package.json executa: 
      # start-server-and-test start http://localhost:3000/api-doc test
      # Isso garante que o servidor 'serverest' ligue e os testes rodem.
      run: npm run cy:run-ci

    - name: âš™ï¸ Criar Artefato BÃ¡sico para PublicaÃ§Ã£o
      # Cria o diretÃ³rio '_site' (necessÃ¡rio para o GitHub Pages)
      # Nota: Seus testes Cypress/Mocha geram um relatÃ³rio HTML mais completo,
      # vocÃª deve COPIAR esse relatÃ³rio para '_site/index.html'
      run: |
        mkdir _site
        echo "<h1>âœ… Testes Executados com Sucesso no MÃ³dulo 4!</h1>" > _site/index.html
        echo "<p>Resultados gerados em ${{ github.sha }}</p>" >> _site/index.html
        # Exemplo: cp ./caminho/do/seu/relatorio.html _site/index.html

    # --- ETAPAS DE PUBLICAÃ‡ÃƒO DO ARTEFATO ---

    - name: ğŸ”¨ Configurar GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: â¬†ï¸ Publicar o Artefato
      uses: actions/upload-pages-artifact@v3
      with:
        path: './_site' # Publica o conteÃºdo da pasta _site

    - name: ğŸš€ Deploy no GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4